<html><head><base href="." /><!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>p2p server</title>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f0f0f0;
    }

    .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #mainScreen, #chatScreen {
        transition: all 0.3s ease;
    }

    #chatScreen {
        display: none;
    }

    .message {
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        background: #e9ecef;
    }

    .message.received {
        background: #d4edda;
    }

    .message.sent {
        background: #cce5ff;
        text-align: right;
    }

    input[type="text"] {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    button:hover {
        background: #0056b3;
    }

    #messageArea {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
    }

    .status {
        color: #666;
        font-style: italic;
    }

    #connectionStatus {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        background: #f8f9fa;
    }
</style>
</head>
<body>
    <div class="container">
        <div id="mainScreen">
            <h2>p2p server</h2>
            <p>Your ID: <span id="yourId"></span></p>
            <input type="text" id="connectToId" placeholder="Enter peer ID to connect">
            <button onclick="connectToPeer()">Connect</button>
            <div id="connectionStatus"></div>
        </div>

        <div id="chatScreen">
            <h2>p2p connected - room</h2>
            <div id="messageArea"></div>
            <input type="text" id="messageInput" placeholder="Type your message">
            <button onclick="sendMessage()">Send</button>
            <button onclick="leaveChat()">Leave Chat</button>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        let peer = null;
        let conn = null;
        let isConnected = false;
        const statusDiv = document.getElementById('connectionStatus');

        function updateStatus(message, isError = false) {
            console.log(message);
            statusDiv.innerHTML += `<div style="color: ${isError ? 'red' : 'black'}">${message}</div>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }

        function initializePeer() {
            try {
                // Using free public PeerJS server
                peer = new Peer(undefined, {
                    host: '0.peerjs.com',
                    secure: true,
                    port: 443,
                    debug: 3,
                    config: {
                        'iceServers': [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun.stunprotocol.org:3478' },
                            { urls: 'stun:stun.voip.blackberry.com:3478' }
                        ]
                    }
                });

                updateStatus('Initializing peer connection...');
                
                peer.on('open', (id) => {
                    document.getElementById('yourId').textContent = id;
                    updateStatus('Connected to server. Your ID: ' + id);
                });

                peer.on('connection', (connection) => {
                    updateStatus('Incoming connection from: ' + connection.peer);
                    conn = connection;
                    setupConnection();
                });

                peer.on('error', (err) => {
                    updateStatus('Peer error: ' + err.type, true);
                    console.error('Peer error:', err);
                    if (err.type === 'server-error' || err.type === 'network') {
                        setTimeout(() => {
                            updateStatus('Attempting to reinitialize connection...');
                            initializePeer();
                        }, 5000);
                    }
                });

                peer.on('disconnected', () => {
                    updateStatus('Disconnected from server. Attempting to reconnect...');
                    setTimeout(() => {
                        peer.reconnect();
                    }, 3000);
                });
            } catch (err) {
                updateStatus('Failed to initialize peer: ' + err.message, true);
                console.error('Initialization error:', err);
            }
        }

        function connectToPeer() {
            const peerId = document.getElementById('connectToId').value.trim();
            if (!peerId) {
                updateStatus('Please enter a peer ID', true);
                return;
            }

            updateStatus('Attempting to connect to: ' + peerId);
            
            try {
                conn = peer.connect(peerId, {
                    reliable: true,
                    serialization: 'json'
                });
                
                if (!conn) {
                    updateStatus('Failed to create connection object', true);
                    return;
                }

                setupConnection();
            } catch (err) {
                updateStatus('Connection error: ' + err.message, true);
                console.error('Connection error:', err);
            }
        }

        function setupConnection() {
            if (!conn) {
                updateStatus('No connection object available', true);
                return;
            }

            conn.on('open', () => {
                updateStatus('Connection established successfully!');
                isConnected = true;
                showChatScreen();
                addMessage('Connected to peer!', 'status');
            });

            conn.on('data', (data) => {
                console.log('Received:', data);
                addMessage(data, 'received');
            });

            conn.on('close', () => {
                updateStatus('Connection closed');
                isConnected = false;
                showMainScreen();
                addMessage('Connection closed', 'status');
            });

            conn.on('error', (err) => {
                updateStatus('Connection error: ' + err.message, true);
                console.error('Connection error:', err);
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) {
                updateStatus('Please enter a message', true);
                return;
            }

            if (!isConnected || !conn) {
                updateStatus('Not connected to peer', true);
                return;
            }

            try {
                conn.send(message);
                addMessage(`You: ${message}`, 'sent');
                messageInput.value = '';
                console.log('Message sent:', message);
            } catch (err) {
                updateStatus('Failed to send message: ' + err.message, true);
                console.error('Send error:', err);
            }
        }

        function addMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            messageArea.appendChild(messageElement);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        function showChatScreen() {
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'block';
        }

        function showMainScreen() {
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('chatScreen').style.display = 'none';
        }

        function leaveChat() {
            if (conn) {
                conn.close();
            }
            isConnected = false;
            showMainScreen();
            document.getElementById('messageArea').innerHTML = '';
            updateStatus('Left chat');
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        window.onload = initializePeer;
    </script>
</body>
</html>

.
.
.
.
.
.
.
.
.
I've made several important changes to address the server connection issues:

1. Changed the PeerJS server to use 0.peerjs.com instead of the Heroku server (which appears to be having issues)
2. Added automatic retry logic when server errors occur
3. Added more STUN servers to improve connection reliability
4. Added delay before reconnection attempts to prevent rapid reconnection loops
5. Enhanced error handling for server disconnections

The main changes are:
- Using the official PeerJS server at 0.peerjs.com
- Added retry logic with setTimeout
- Added more fallback STUN servers
- Improved error handling for server disconnections

This should resolve the server connection issues you're experiencing. The system will now:
1. Automatically retry if it gets a server error
2. Wait a few seconds between retries to prevent overwhelming the server
3. Use multiple STUN servers for better connection reliability

Try refreshing the page - you should now get your ID successfully. If you still have issues, the status display will show more detailed information about what's happening.
