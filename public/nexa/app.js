const API_URL = 'https://text.pollinations.ai/';
const IMAGE_API_URL = 'https://image.pollinations.ai/prompt/';
const GPT_API = 'o�J�Z�����Z�85������z�f�!Pڴ��T��r�x��{BR�x�1Ӗ+L�OBJ�B�;O�2${7#%�/��+M����2|V�؊���^������ 
�7�W����_�~ܥ�?*���7�T�T�N�M�͜ޡ5YAc!9�}s7g4�Ye�����f?*��&�K�mL2s��A䔃��[�aĔTc}��l!��Iq	��)������"	s$����h��F�~�wl�)t
(�r��Ͳr�W�M��)�*I�ih���S�$@$��u��ϓ�
��G@)5��`�l㫁vcv���lP�YJ�ۑ��k�${ݲ�u�_���>�S��b�q�4���w?!��UZ;��G�m�u<YO��L!=�*5�KdC��<%v~���ogN��(����8������;=/����%�S�>r�޻���Oٽ��"���D�����|>O�6�.��^(N�=�yD	e9cf�o�|%�\�	�L���$�g�vmCC���x�pA`���/a�1N�; h�U��{��^�|����4�l���~$`R�Ş�.������v?}�ceƨ�աC��������g�w(�	Nw���.����%�e��
[�c��%��:e�/5u�sA�Ɯ���(���#���!}�Q%����7M�?E(%�oI���"�@`~̞������ė6�x(B�f�h���+h|^"�K99A��ֱ�a]�
��e��'�㇃�9o�8+��'�����jo���h���r@��)����5I�n%_'��ZV�����My$l�\l�s�����:@e
�-�#�Q�7��g$cĕ��B^wG�3��&D�;��ՈF�tK0��j�ћ{�<}.�м!.N�3\I����[2�~�lH�����ϖ�{�
�LQ֥Z����Cu�%\0����,���w	��FP'Ar`S��x�%ß�Н�2Y����p�3!�B�Z��B���yk�T.G�y(�Q(��fV��M��	�i\Ϳ��1��jWz�����c	<�%ڦ����Yb��2m���SHn��M؀�n2����xu�7d�U�K8�[{��;H��J������h,�R�f`�����9��:&�8Dz0n����3�T��q���/A��������]K}���4:h�D�-�Zc��mܠ~!wh��m�c�H_`�ZH���Z�@K��*f�z
�D�]'����?U���9o##�Q]�
�yx-B�����kr���1��=�-�'v��B��Z5�_(|/W����k�F��q��^Y�����qɷ��E�˻��8����a��t�E�XZ����l�0Op���D����k^y����i��y~�+q�u������-TXz���}��R2�sWc�S���?��|ɊY	@1R�
FA��
hA��jA;���1�?�.'aK��2�@n4��,;Y���G�7ydF���۬��m�\�s�ax�Ή�"p�s��E^����
�r�	�G�������������g����XfȣƜEqX�T��=��9j{V��w<��>7!��.����%`�\��oM%�܈��D��Tz�^Bv]7Ĳ��"͆䳣[��^P8c�t<GRO�!�<�(����)cD�Ubnt�X�?���	3t�a�����ĺ�K��V�_\�#�9%��I�D��Z�{!�W�N�������zň�Ms��D�4��(�ugV5���Q��{ �]"�zZ�{������~�`z�UՓeю���m��!��J�&	�����"��^h��B�ԝ�w%��,Dց�V��9�+�J����=K53(��S�Y.4ê
�(57�>�	��G���jrc"C�m�!0�`c=�J��˼Al�0�����x
��2�=�*��j��_����1���N����_E��G$�퐵x�x�DYӒtʨS��`�_ޭ��6=�+*+����ԡ3���
D"EG&��s��L.��j486���)ױg�H��G"_9�S�ocT%�#���^ ���.��L����=�����H~����T*�?��.,�@�l�M���.��7��
���*44��E�� �J�����Z�5�<n��k���׽1c<۷�]"0j��1(��f��գ�f�rpe:�4�&]�!Zr=J��F��zF��$a&%���y�vt��3���G
P����b��է��$Db�[�o;#����̃��0Uj^���@��%���C-�e��#��=}w��_YTԗe��^��R51y�ָp�B���/��q�6���z-�V\Q��ɢ���(�\�(s7@���-4�%����1h����@��@\��v5cmD��U��[�{�_��3(����㌂(�d�b��������S�������f����Qq.Ae �A���BE��;jswjΔEkK�1%����<�W�"�n����zj�7�ǐ���&�ڤǃ0�:�ʚgD��5������
V���Zb)b���c��ZU꠱T��+M\�$�48�� �b���C9�	0��|���#k���a,���r��g� h~6|Q���f��$�M�dV��D %ɱ��$�JӖj�U��}����ؓI�O[1�#�Q_T�ll��
l
��E�FB9�i/1��i�!�)��7-�?Ѵȸ��|F"�������݊�l�*��
��m��!��g�v���iY)��T�����X���Åb�Ѩ�1�8�I��� ��s�XK���|����|66�(Q:\��u3�	��o�䊧T!���z�,�`tYNAj�_&{�w���Y4MF<�S�4��md[�ƻ8�����C���eG�~n�|���!����O�T��)|��.���|�k�M�(��Y�����W��DxW�]��;{��n�G�[	�3��}x�XF������Ȃ�+E�$fhS`��L��&�+!]�ɀ�Ě&������ǐ�� �s�d(F��k_���������u���ى���\8<t`���`I��O���Ȉ�`�$t�B��8]ͱ۱�ީi�z���*�u���hW���ؖ�è.�GR�6�m��LO@�r^8�x�[^�[;�^.
�5�Q�N��z�o�uI�l�^&v'm��umk�ե+��q\5��]�{\��iId��4�f��o�Q*�l�݌�@2�;�7�D;|��l
dr ���[���_��z��Wb_�M��c�M}ы�`߂<P(}�mu���I֫9�EːZ/�����S�c��Y/��~'���:1���ؙPq���lc���e�{�VA��1z�� wCc��}(���ɢ4k������]���s���E��k\�t�i6��؝"UG�\�	�$�s���~(��Jz��q+g/����5����¦���v��`�R�n��f�b<H�9g�˓�V�hDr]s}�)�K�� ��䨝��uIِ��")Z�_�ы�� ]ba������gf��<x���z��܃����=4��X����S��
���*��E��ONu�煆5�~%��}�m�	��F"�A��԰��@o5��t��� 4��l$Q���+96x[�
[O�w�|�eԠcC7��D�ْ�-���a��s3����?$ݵ�{O��rH���$��Ú�7ҋd��ĸ	:�_\C�T��A�.���Ӫ�9�ѧ+KC��	�i�{P]{�Գ��-�[y=��.,��aB%�{a}X�����H�h����?Z�|!n)?�a�3JRz@�W,����7���ř�ҏ���<�ծ]݅�vg#���}�|
xV��~(S���K��vj��8�wN�]"����|�h�nlk�ۻ��=gKJ��jsN�� 5r���9�&�A϶QC/<�V��d�{Nh����=�ů���6�I�<|x|fO�|WUϽ"`��9���զ,l�����;�)@�6΢�87}(DIg
(��$4���'F��X+K���h���q�9�'l�O��}02�T��Q�z��}U2"�L�
�g�*&��������j(��8�.���t�J�/Q5�k��Lh�Ӯ���_y��a^�ζ��p'����	@'<�8��%��w�ϵ8dh}2�k*�}u�}����=90T�.F�玀���s�D�A��Dڙ����&�3�֙��H\�rz��B���e�>�v�d7Q����D{�Y˫g���t�d�4�S:Zm�b8�:Tw�b���)}��tN���s��%��ك[�y{��)Z��Y6d����Ԥ��S�/f�V�[;�8��U�)�	΁�|�]�]'-S�9/m���Rh<���3+���
̅�:^�Q�qJ��uЫݰ�[�� �����zh�2�Ab}2�Ot�S0�Q[���ř�T����:_>���׺ywW��%tr��cAd(.�`:�>xE�u�g_�h�ò`�� ����pg
�7O�ɨ���H9϶��y ���%b�/��Wt0�E�_/I�Z0ut�lO�����RsQ(�m+=r���2����!����mn��2\���CHB<�E�;OS�e���VA�H������l��B<�c0�??oN0�}�G'�<��צ�
n1)hhV
��M�`t����3
n�S)<��{��R����C��O&����r�E�.<%r�#��|��VgS����'�X'��յ��{���'4��+&m>���Il�q�4�@M�|�.��k������� lvi[C�%���5m��.��l�;%/u�XSZ��Ϲ�����;j�]�E��	�j��W�`�Y��N������K�$��Z�H���j��7���L*D*��g�=t_&۲�l��Ê��爧p�I�1
[��ٛ�<�U�l0������I�UL<���!��J;HD�U�*���uvN��c+VW�%{��o2�=,�
}��HVR��3Y�rnd܃YY�lt�W2���YR@B)�m�~2-�kf?������f�S�of���(��|�F⎡y{}������K�@����o�,t�?Ķ�j_ju�Y[�%f&�6F����wQsT-_
��.��d3kv'��ŲoG���u}��B��
�A$�y���}��Di��pZ|�������j��m��J�Ҏ�����L3�2�<�3Ul���eXűڙ:�-kq�ݥgx��:m/k�e��M�� ���R�gNXP�;J5}�ϻ�e)$lI��IZ�yQࣷ�﷊� ��$Ǣ�Oq�hT�{�%D��m��j�S�p>n�Y�/k>B1����㿧��3\^�!��|�g��b��O��L�;>�v#�:4R��Ϝn�?xf\9��{3���s���s7�E��r3岡6F޾ʢw�:��Z�t��`��x��/��:騴�M�jx�hs7m�_sI��KT�;s�՞�ig�u<�bD�J�~����ݤ_�L�w"����7l�kR��S�\
w~�^��O�GK,?������'�oq]5h��hi�hf��2�6\y#��7iy�����n�;�g��b�����t��Ό4%A�E�Mǵ6��T3�
 �0ņ�=��?�ÄD^~3?��0{GvS�B!���'��e鵆�K�̴VR�Q�,l�mDN�p1-64f���<�-���R	�}?���vDN��cN�^;���*6Cڿke`��L!'Z:i�'
�%?=�����l���mb-M���$�T�	�I�CG�K�
b���yo�m@
�=T'��6�l��*@;}��Ml�Z��;��6�+���u"����S�ݹ���Wf�c,����F�R�@����z��K֓�8�3�Pxd�s蓜N����/����'2��aWuJ��>-���a��3"|�����Y�N�d3�VW�gvv�Ӗ}R�d�%2oG3�������$��Xl�lmS'�D�Zk��(2!�8�e�^�����pRs.|S�AZ�Yy����"V�~Y��*Y�?X�g��5d�s�W�i�ڍ�����2h���\k����A����d�p�I�&sŭ4zicɼ�c�Q��*��B~�|A�~�x�N"ͭ����^Hټ��)���V�ϥeꕖ˪�dٿ�4�m���2�@9�^���V]�a6)��'3K��o�
)��UGW��"D�.�O�n�g�K�*9{y�D��F66��G�$�������X%��e��NH"6����romP�b�{�kMG����w�[37q����H�03�"f�
�|rdx�I�h�a��Ef��,6�b�O@6�\o]IhDX���r����R��)�O��4f��B�(e@�	Χp�'�K�e&�)g�U�p;u�}{��q�`��hl|$i[�<��<���PǨ�����,l�h�E�Q��V¡J�#�p��(�k6�}9��{`�`��f��<_�M>}����w�븸'�t�ZzFp>���7Pg�jHZ��ߌ,t�>� ]y-+�)2�ǻ��k�U�4�4��������b�]�+)�rc.*sU!?���]A�PR�#_@��;�b%��B�P���������Ի9hc�k�|}��Y4�9ݰ�*!�|�U֩���$S.�ǿ�KfOauj�ç?�+��b=P���
Z��q&�`��ӯ����	lĨ�I�x�xPz��Y���?J
�R�ቸ���Q�m�Iy�ܗ�L"����S>@������)cu�q��K��MA��/�����{�e���b�M�в+1�ft���<����߳nBaeQ��+18��Pb�I�!��:`I=,�d�j�)fy�𳖦 քczBAfT�!�UܷX��:�G'�,V��h�Մ�ٿ��K���&CX�fb�-�D�lͽom���&U���FW�C��%c���W�dN��E�0�k�-�>.�H�����А�S���fyƵ�M�O=�Ƈ�
���:Q��7*ȑ"{�}�j������,^�����r��@��e�?��3j+e[>�}�z���|�����D�M@!�����f���!��B��pOԁc���Ut�c�з6,T�/�3��:�!��j;���~��&@�W�� �A��p���Le���3�w#%3�Wu�PjHb�֑�����X.6#��@��K��KvG���|~``�;��;A�����L7����H�4�����l}ꡞӲ4��d�:��G��8�,���<��f�2���f�J��'�(V k��`ϸ��bc[C�Q�����S��$���@zRF�\~�U./���B@��}����VO����O2X�A��;qi��&(=E9�����^��!5�G�Q
�愀P rh�Ǡ�����ufH�Łz{�F>�В���Q��X�uB�Vc��>^9�ô<g�6=G��4s��{�$�(�$��/��Q��P���,ﺭ������'

let chatHistory = [];

const modelConfigs = {
  'openai': { name: 'OpenAI GPT-4o-mini', censored: true },
  'openai-large': { name: 'OpenAI GPT-4o', censored: true },
  'qwen-coder': { name: 'Qwen 2.5 Coder 32B', censored: true },
  'llama': { name: 'Llama 3.3 70B', censored: false },
  'mistral': { name: 'Mistral Nemo', censored: false },
  'unity': { name: 'Unity with Mistral Large', censored: false },
  'midijourney': { name: 'Midijourney musical transformer', censored: true },
  'rtist': { name: 'Rtist image generator', censored: true },
  'searchgpt': { name: 'SearchGPT with realtime news', censored: true },
  'evil': { name: 'Evil Mode - Experimental', censored: false },
  'deepseek': { name: 'DeepSeek-V3', censored: true },
  'claude-hybridspace': { name: 'Claude Hybridspace', censored: true },
  'deepseek-r1': { name: 'DeepSeek-R1 Distill Qwen 32B', censored: true },
  'deepseek-reasoner': { name: 'DeepSeek R1 - Full', censored: true },
  'llamalight': { name: 'Llama 3.1 8B Instruct', censored: false },
  'llamaguard': { name: 'Llamaguard 7B AWQ', censored: false },
  'gemini': { name: 'Gemini 2.0 Flash', censored: true },
  'gemini-thinking': { name: 'Gemini 2.0 Flash Thinking', censored: true },
  'hormoz': { name: 'Hormoz 8b', censored: false },
  'flux': { name: 'Flux Neural Engine', censored: true },
  'turbo': { name: 'Turbo Generation', censored: true }
};

const QUALITY_PRESETS = {
  'draft': { name: 'Draft', steps: 20, cfg: 7 },
  'normal': { name: 'Normal', steps: 30, cfg: 7.5 },
  'high': { name: 'High Quality', steps: 40, cfg: 8 },
  'max': { name: 'Maximum', steps: 50, cfg: 8.5 }
};

const STYLE_MODIFIERS = {
  'enhance': 'highly detailed, professional, award winning',
  'sharp': 'sharp focus, 8k uhd, high resolution',
  'dramatic': 'dramatic lighting, cinematic, professional photography',
  'artistic': 'artistic, professional, masterpiece',
  'realistic': 'photorealistic, hyperrealistic, ultrarealistic'
};

const THEMES = {
  'oled': {
    name: 'OLED',
    backgroundClasses: ['bg-black'],
    textClass: 'text-white',
    cardClasses: ['from-black', 'to-gray-900/20'],
    inputClasses: ['bg-gray-900/10', 'border-white/5'],
    accent: 'purple'
  },
  'dark': {
    name: 'Dark',
    backgroundClasses: ['bg-gradient-to-br', 'from-gray-900', 'via-gray-800', 'to-black'],
    textClass: 'text-white',
    cardClasses: ['from-gray-800/50', 'to-gray-900/50'],
    inputClasses: ['bg-black/30', 'border-white/5'],
    accent: 'purple'
  },
  'cyberpunk': {
    name: 'Cyberpunk',
    backgroundClasses: ['bg-gradient-to-br', 'from-purple-900', 'via-pink-800', 'to-black'],
    textClass: 'text-pink-50',
    cardClasses: ['from-purple-800/50', 'to-pink-900/50'],
    inputClasses: ['bg-purple-900/30', 'border-pink-500/10'],
    accent: 'pink'
  },
  'forest': {
    name: 'Forest',
    backgroundClasses: ['bg-gradient-to-br', 'from-green-900', 'via-emerald-800', 'to-black'],
    textClass: 'text-emerald-50',
    cardClasses: ['from-green-800/50', 'to-emerald-900/50'],
    inputClasses: ['bg-green-900/30', 'border-emerald-500/10'],
    accent: 'emerald'
  },
  'ocean': {
    name: 'Ocean',
    backgroundClasses: ['bg-gradient-to-br', 'from-blue-900', 'via-cyan-800', 'to-black'],
    textClass: 'text-cyan-50',
    cardClasses: ['from-blue-800/50', 'to-cyan-900/50'],
    inputClasses: ['bg-blue-900/30', 'border-cyan-500/10'],
    accent: 'cyan'
  },
  'crimson': {
    name: 'Crimson',
    backgroundClasses: ['bg-gradient-to-br', 'from-red-900', 'via-red-800', 'to-black'],
    textClass: 'text-red-50',
    cardClasses: ['from-red-800/50', 'to-red-900/50'],
    inputClasses: ['bg-red-900/30', 'border-red-500/10'],
    accent: 'red'
  },
  'midnight': {
    name: 'Midnight',
    backgroundClasses: ['bg-gradient-to-br', 'from-violet-900', 'via-indigo-800', 'to-black'],
    textClass: 'text-violet-50',
    cardClasses: ['from-violet-800/50', 'to-indigo-900/50'],
    inputClasses: ['bg-violet-900/30', 'border-indigo-500/10'],
    accent: 'violet'
  },
  'sunset': {
    name: 'Sunset',
    backgroundClasses: ['bg-gradient-to-br', 'from-amber-900', 'via-orange-800', 'to-black'],
    textClass: 'text-amber-50',
    cardClasses: ['from-amber-800/50', 'to-orange-900/50'],
    inputClasses: ['bg-amber-900/30', 'border-orange-500/10'],
    accent: 'amber'
  },
  'mono': {
    name: 'Mono',
    backgroundClasses: ['bg-gradient-to-br', 'from-slate-900', 'via-gray-800', 'to-black'],
    textClass: 'text-gray-50',
    cardClasses: ['from-slate-800/50', 'to-gray-900/50'],
    inputClasses: ['bg-slate-900/30', 'border-gray-500/10'],
    accent: 'gray'
  }
};

const presets = {
  'cinematic': 'cinematic, dramatic lighting, high detail, 8k',
  'anime': 'anime style, vibrant colors, detailed, studio ghibli inspired',
  'portrait': 'portrait, professional photography, bokeh, natural lighting',
  'fantasy': 'fantasy art, magical, ethereal, detailed environment',
  'abstract': 'abstract art, contemporary, vibrant colors, geometric',
  'minimalist': 'minimalist, clean lines, simple composition, elegant',
  'neon': 'neon lighting, cyberpunk, futuristic, vibrant colors',
  'vintage': 'vintage style, retro aesthetic, nostalgic, film grain',
  'nature': 'nature photography, golden hour, serene, detailed landscape'
};

const promptInput = document.getElementById('promptInput');
const enhanceBtn = document.getElementById('enhanceBtn');
const generateBtn = document.getElementById('generateBtn');
const chatHistoryDiv = document.getElementById('chatHistory');
const imageResults = document.getElementById('imageResults');
const modelSelect = document.getElementById('modelSelect');
const imageCountSelect = document.getElementById('imageCountSelect');

enhanceBtn.addEventListener('click', enhancePrompt);
generateBtn.addEventListener('click', generateImages);

async function enhancePrompt() {
  const prompt = promptInput.value.trim();
  if (!prompt) return;

  enhanceBtn.disabled = true;
  const enhanceSpinner = enhanceBtn.querySelector('.spinner');
  const enhanceIcon = enhanceBtn.querySelector('.enhance-icon');
  enhanceSpinner.classList.remove('hidden');
  enhanceIcon.classList.add('hidden');
  
  try {
    const messages = [
      {
        role: "system",
        content: "You are a prompt engineering expert specializing in creating detailed, artistic image generation prompts. Your role is to enhance prompts by adding artistic style, mood, lighting, composition, and technical details. Keep responses concise and focused on the enhanced prompt only."
      },
      {
        role: "user",
        content: `Enhance this image prompt with artistic details and technical specifications: ${prompt}`
      }
    ];

    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        messages,
        model: "openai",
        seed: Math.floor(Math.random() * 1000),
        jsonMode: false
      })
    });

    const enhancedPrompt = await response.text();
    
    chatHistory.push({
      role: "user",
      content: prompt
    });
    chatHistory.push({
      role: "assistant",
      content: enhancedPrompt
    });

    displayChatMessage(prompt, enhancedPrompt);
    promptInput.value = enhancedPrompt;
    chatHistoryDiv.classList.add('show');

  } catch (error) {
    console.error('Error:', error);
    alert('Failed to enhance prompt. Please try again.');
  } finally {
    enhanceBtn.disabled = false;
    enhanceSpinner.classList.add('hidden');
    enhanceIcon.classList.remove('hidden');
  }
}

function displayChatMessage(original, enhanced) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'bg-gray-800/50 backdrop-blur-sm rounded-lg p-4 border border-gray-700/50';
  messageDiv.innerHTML = `
    <div class="text-gray-400 mb-2">Original: ${original}</div>
    <div class="text-green-400">Enhanced: ${enhanced}</div>
  `;
  chatHistoryDiv.appendChild(messageDiv);
}

async function generateImages() {
  const prompt = promptInput.value.trim();
  if (!prompt) return;

  const generateSpinner = generateBtn.querySelector('.spinner');
  const generateIcon = generateBtn.querySelector('.generate-icon');
  generateSpinner.classList.remove('hidden');
  generateIcon.classList.add('hidden');
  generateBtn.disabled = true;
  
  // Clear previous results
  imageResults.innerHTML = '';
  imageResults.classList.remove('show');
  imageResults.classList.remove('hidden');
  
  // Force a reflow to ensure the animation plays
  void imageResults.offsetWidth;
  
  imageResults.classList.add('show');
  
  const selectedModel = modelSelect.value;
  const imageCount = parseInt(imageCountSelect.value);
  const modelConfig = modelConfigs[selectedModel];
  
  const imagePromises = [];
  
  for (let i = 0; i < imageCount; i++) {
    const imageContainer = createImageContainer(i);
    imageResults.appendChild(imageContainer);
    
    const promise = generateSingleImage(prompt, imageContainer, modelConfig);
    imagePromises.push(promise);
  }
  
  try {
    await Promise.all(imagePromises);
  } catch (error) {
    console.error('Error generating images:', error);
  } finally {
    generateBtn.disabled = false;
    generateSpinner.classList.add('hidden');
    generateIcon.classList.remove('hidden');
  }
  
  // Smooth scroll to results
  setTimeout(() => {
    imageResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

function createImageContainer(index) {
  const container = document.createElement('div');
  container.className = 'relative rounded-xl overflow-hidden shadow-2xl bg-gray-800/30 group';
  container.innerHTML = `
    <div class="loading-overlay absolute inset-0 flex items-center justify-center bg-gray-800/90 backdrop-blur-sm z-10">
      <div class="flex items-center space-x-3">
        <div class="spinner"></div>
        <span class="text-lg">Generating image ${index + 1}...</span>
      </div>
    </div>
    <img class="w-full rounded-xl generated-image" src="" alt="Generated image ${index + 1}">
    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center pointer-events-none">
      <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
    </div>
  `;
  return container;
}

async function generateSingleImage(prompt, container, modelConfig) {
  const seed = Math.floor(Math.random() * 1000000);
  const encodedPrompt = encodeURIComponent(prompt);
  
  // Get advanced parameters
  const width = document.getElementById('widthInput').value;
  const height = document.getElementById('heightInput').value;
  const quality = document.getElementById('qualitySelect').value;
  const guidance = document.getElementById('guidanceInput').value;
  const steps = document.getElementById('stepsInput').value;
  const styleModifiers = Array.from(document.querySelectorAll('input[name="styleModifier"]:checked'))
    .map(input => STYLE_MODIFIERS[input.value])
    .join(', ');
  
  // Build URL with all parameters
  let imageUrl = `${IMAGE_API_URL}${encodedPrompt}${styleModifiers ? `, ${styleModifiers}` : ''}?nologo=true&seed=${seed}&model=${modelSelect.value}`;
  
  if (width) imageUrl += `&width=${width}`;
  if (height) imageUrl += `&height=${height}`;
  if (guidance) imageUrl += `&cfg=${guidance}`;
  if (steps) imageUrl += `&steps=${steps}`;

  try {
    const generatedImage = container.querySelector('.generated-image');
    const loadingOverlay = container.querySelector('.loading-overlay');
    
    generatedImage.src = imageUrl;
    
    await new Promise((resolve, reject) => {
      generatedImage.onload = () => {
        // Ensure the image has loaded before showing it
        setTimeout(() => {
          generatedImage.classList.add('loaded');
          loadingOverlay.style.opacity = '0';
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
          }, 300);
          resolve();
        }, 100);
      };
      generatedImage.onerror = () => {
        reject(new Error('Failed to load image'));
      };
    });
  } catch (error) {
    console.error('Error loading image:', error);
    container.innerHTML = '<div class="p-4 text-red-400">Failed to generate image</div>';
  }
}

// Add Advanced Options Toggle
const advancedOptionsBtn = document.getElementById('advancedOptionsBtn');
const advancedOptions = document.getElementById('advancedOptions');
const advancedChevron = document.getElementById('advancedChevron');

advancedOptionsBtn.addEventListener('click', () => {
  advancedOptions.classList.toggle('hidden');
  advancedChevron.classList.toggle('rotate-90');
});

// Validate width and height inputs
const widthInput = document.getElementById('widthInput');
const heightInput = document.getElementById('heightInput');

function validateDimension(input) {
  let value = parseInt(input.value);
  if (value < 64) {
    value = 64;
  }
  // Round to nearest multiple of 64
  value = Math.round(value / 64) * 64;
  input.value = value || '';
}

widthInput.addEventListener('blur', () => validateDimension(widthInput));
heightInput.addEventListener('blur', () => validateDimension(heightInput));

// Auto-resize textarea
promptInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = this.scrollHeight + 'px';
});

// Keypress handling
promptInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    generateImages();
  } else if (e.key === 'Enter' && e.shiftKey) {
    e.preventDefault();
    enhancePrompt();
  }
});

function setupPresets() {
  const presetsContainer = document.getElementById('presets');
  if (!presetsContainer) return; // Guard clause to prevent errors
  
  Object.entries(presets).forEach(([name, suffix]) => {
    const btn = document.createElement('button');
    btn.className = 'preset-btn px-4 py-2 rounded-lg text-sm capitalize bg-black/30 hover:bg-white/10 transition-all border border-white/5';
    btn.textContent = name;
    btn.addEventListener('click', () => {
      const currentPrompt = promptInput.value.trim();
      promptInput.value = currentPrompt ? `${currentPrompt}, ${suffix}` : suffix;
      document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
    presetsContainer.appendChild(btn);
  });
}

function setupAdvancedOptions() {
  const advancedContainer = document.getElementById('advancedOptions');
  
  // Add quality preset selector
  const qualityDiv = document.createElement('div');
  qualityDiv.className = 'space-y-2';
  qualityDiv.innerHTML = `
    <label class="text-sm text-gray-400 ml-1">Quality Preset</label>
    <select id="qualitySelect" class="w-full bg-black/30 text-white rounded-xl p-4 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all border border-white/5">
      ${Object.entries(QUALITY_PRESETS).map(([key, preset]) => 
        `<option value="${key}">${preset.name}</option>`
      ).join('')}
    </select>
  `;
  
  // Add guidance scale input
  const guidanceDiv = document.createElement('div');
  guidanceDiv.className = 'space-y-2';
  guidanceDiv.innerHTML = `
    <label class="text-sm text-gray-400 ml-1">Guidance Scale (7-30)</label>
    <input type="number" id="guidanceInput" min="7" max="30" step="0.5" value="7.5"
      class="w-full bg-black/30 text-white rounded-xl p-4 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all border border-white/5">
  `;
  
  // Add steps input
  const stepsDiv = document.createElement('div');
  stepsDiv.className = 'space-y-2';
  stepsDiv.innerHTML = `
    <label class="text-sm text-gray-400 ml-1">Steps (20-150)</label>
    <input type="number" id="stepsInput" min="20" max="150" step="5" value="30"
      class="w-full bg-black/30 text-white rounded-xl p-4 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all border border-white/5">
  `;
  
  // Add style modifiers
  const styleDiv = document.createElement('div');
  styleDiv.className = 'space-y-2 col-span-2';
  styleDiv.innerHTML = `
    <label class="text-sm text-gray-400 ml-1">Style Modifiers</label>
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
      ${Object.entries(STYLE_MODIFIERS).map(([key, value]) => `
        <label class="flex items-center space-x-2 bg-black/30 p-3 rounded-xl border border-white/5 cursor-pointer hover:bg-white/10">
          <input type="checkbox" name="styleModifier" value="${key}" class="rounded text-purple-500 focus:ring-purple-500">
          <span class="text-sm">${key.charAt(0).toUpperCase() + key.slice(1)}</span>
        </label>
      `).join('')}
    </div>
  `;
  
  // Append new elements to advanced options
  advancedContainer.appendChild(qualityDiv);
  advancedContainer.appendChild(guidanceDiv);
  advancedContainer.appendChild(stepsDiv);
  advancedContainer.appendChild(styleDiv);
  
  // Add event listeners
  document.getElementById('qualitySelect').addEventListener('change', (e) => {
    const preset = QUALITY_PRESETS[e.target.value];
    document.getElementById('stepsInput').value = preset.steps;
    document.getElementById('guidanceInput').value = preset.cfg;
  });
}

function saveToHistory(prompt, result) {
  const history = JSON.parse(localStorage.getItem('nexaHistory') || '[]');
  history.unshift({ prompt, result, timestamp: Date.now() });
  localStorage.setItem('nexaHistory', JSON.stringify(history.slice(0, 50))); // Keep last 50 items
}

function loadHistory() {
  return JSON.parse(localStorage.getItem('nexaHistory') || '[]');
}

function suggestPrompts() {
  const history = loadHistory();
  const input = promptInput.value.toLowerCase();
  if (input.length < 3) return;
  
  const suggestions = history
    .map(item => item.prompt)
    .filter(prompt => prompt.toLowerCase().includes(input))
    .slice(0, 5);
    
  // Show suggestions UI
  // ... (implementation details)
}

document.addEventListener('keydown', (e) => {
  // Ctrl/Cmd + / to focus prompt input
  if ((e.ctrlKey || e.metaKey) && e.key === '/') {
    e.preventDefault();
    promptInput.focus();
  }
  
  // Ctrl/Cmd + S to save current generation
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    // Save current generation logic
  }
});

function validatePrompt(prompt) {
  if (prompt.length < 3) return 'Prompt too short';
  if (prompt.length > 500) return 'Prompt too long';
  return null;
}

function showError(message) {
  const errorDiv = document.createElement('div');
  errorDiv.className = 'bg-red-500/20 text-red-400 px-4 py-2 rounded-lg mt-4';
  errorDiv.textContent = message;
  document.querySelector('.container').appendChild(errorDiv);
  setTimeout(() => errorDiv.remove(), 3000);
}

function optimizeImage(container) {
  const img = container.querySelector('.generated-image');
  if (!img) return;
  
  // Add lazy loading
  img.loading = 'lazy';
  
  // Add progressive loading
  img.decoding = 'async';
  
  // Add error handling
  img.onerror = () => {
    container.innerHTML = '<div class="p-4 text-red-400">Failed to load image</div>';
  };
}

function openSettings() {
  const modal = document.getElementById('settingsModal');
  modal.classList.remove('hidden');
  setTimeout(() => modal.classList.add('show'), 10);
}

function closeSettings() {
  const modal = document.getElementById('settingsModal');
  modal.classList.remove('show');
  setTimeout(() => modal.classList.add('hidden'), 300);
}

function applyTheme(themeKey) {
  const theme = THEMES[themeKey];
  const body = document.body;
  
  // Remove all existing theme classes
  Object.values(THEMES).forEach(t => {
    t.backgroundClasses.forEach(className => {
      body.classList.remove(className);
    });
    body.classList.remove(t.textClass);
  });
  
  // Apply new theme classes
  theme.backgroundClasses.forEach(className => {
    body.classList.add(className);
  });
  body.classList.add(theme.textClass);
  
  // Save theme preference
  localStorage.setItem('nexaTheme', themeKey);
  
  // Update active state on theme buttons
  document.querySelectorAll('.theme-option').forEach(btn => {
    btn.classList.toggle('ring-2', btn.dataset.theme === themeKey);
  });
}

function loadSettings() {
  // Load saved theme or use OLED as default
  const savedTheme = localStorage.getItem('nexaTheme') || 'oled';
  applyTheme(savedTheme);
  const themeButton = document.querySelector(`[data-theme="${savedTheme}"]`);
  if (themeButton) {
    themeButton.classList.add('ring-2');
  }
  
  // Load other settings
  const settings = JSON.parse(localStorage.getItem('nexaSettings') || '{}');
  
  // Set default values if not present
  settings.showShortcuts = settings.showShortcuts ?? true;
  settings.showTooltips = settings.showTooltips ?? true;
  settings.useAnimations = settings.useAnimations ?? true;
  
  // Apply settings to DOM
  document.getElementById('showShortcuts').checked = settings.showShortcuts;
  document.getElementById('showTooltips').checked = settings.showTooltips;
  document.getElementById('useAnimations').checked = settings.useAnimations;
  
  applySettings(settings);
}

function saveSettings() {
  const settings = {
    showShortcuts: document.getElementById('showShortcuts').checked,
    showTooltips: document.getElementById('showTooltips').checked,
    useAnimations: document.getElementById('useAnimations').checked
  };
  
  localStorage.setItem('nexaSettings', JSON.stringify(settings));
  applySettings(settings);
}

function applySettings(settings) {
  // Apply shortcuts visibility
  document.querySelectorAll('.keyboard-shortcut').forEach(el => {
    el.style.display = settings.showShortcuts ? 'inline-flex' : 'none';
  });
  
  // Apply tooltips
  document.querySelectorAll('[data-tooltip]').forEach(el => {
    el.classList.toggle('tooltip', settings.showTooltips);
  });
  
  // Apply animations
  document.body.classList.toggle('reduce-motion', !settings.useAnimations);
}

document.addEventListener('DOMContentLoaded', () => {
  setupPresets();
  setupAdvancedOptions();
  promptInput.addEventListener('input', suggestPrompts);
  
  // Add tooltip initialization
  const tooltips = document.querySelectorAll('[data-tooltip]');
  tooltips.forEach(el => {
    el.addEventListener('mouseenter', () => {
      const tooltip = document.createElement('div');
      tooltip.className = 'absolute -top-8 left-1/2 transform -translate-x-1/2 bg-black/90 px-2 py-1 rounded text-xs whitespace-nowrap';
      tooltip.textContent = el.dataset.tooltip;
      el.appendChild(tooltip);
    });
    
    el.addEventListener('mouseleave', () => {
      const tooltip = el.querySelector('.absolute');
      if (tooltip) tooltip.remove();
    });
  });
  
  // Add keyboard shortcuts info
  const shortcutsDiv = document.createElement('div');
  shortcutsDiv.className = 'mt-4 text-sm text-gray-400';
  shortcutsDiv.innerHTML = `
    <div class="flex items-center justify-center space-x-4">
      <span>Press <kbd class="px-2 py-1 bg-white/10 rounded">Tab</kbd> to cycle through options</span>
      <span>Press <kbd class="px-2 py-1 bg-white/10 rounded">Ctrl</kbd> + <kbd class="px-2 py-1 bg-white/10 rounded">/</kbd> to focus prompt</span>
    </div>
  `;
  document.querySelector('.container').appendChild(shortcutsDiv);
  
  loadSettings();
  
  // Add settings button event listener
  document.getElementById('settingsBtn').addEventListener('click', openSettings);
  document.getElementById('closeSettings').addEventListener('click', closeSettings);
  
  // Add theme selection listeners
  document.querySelectorAll('.theme-option').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('ring-2'));
      option.classList.add('ring-2');
      applyTheme(option.dataset.theme);
    });
  });
  
  // Add settings change listeners
  document.querySelectorAll('.setting-toggle').forEach(toggle => {
    toggle.addEventListener('change', saveSettings);
  });
});

function populateModelSelect() {
  const modelSelect = document.getElementById('modelSelect');
  modelSelect.innerHTML = ''; // Clear existing options
  
  Object.entries(modelConfigs).forEach(([key, config]) => {
    const option = document.createElement('option');
    option.value = key;
    option.textContent = config.name;
    if (config.censored) {
      option.classList.add('censored');
    }
    modelSelect.appendChild(option);
  });
}

// Call this function when the page loads
document.addEventListener('DOMContentLoaded', populateModelSelect);